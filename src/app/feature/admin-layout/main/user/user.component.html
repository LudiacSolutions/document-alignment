<div class="section-header">
  <div>
    <h1>User Management</h1>
    <p>Manage all system users and their subscriptions</p>
  </div>
  <div class="search-and-add">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      (input)="filterUsers()"
      placeholder="Search users..."
      class="search-input"
    />
    <button class="btn btn-primary" (click)="open(addUserModal)">+ Add User</button>
  </div>
</div>

<!-- User Stats -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-title">Total Users</div>
    <div class="stat-value">{{ userStats.total }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-title">Active Today</div>
    <div class="stat-value">{{ userStats.activeToday }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-title">New This Month</div>
    <div class="stat-value">{{ userStats.newThisMonth }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-title">Suspended</div>
    <div class="stat-value danger">{{ userStats.suspended }}</div>
  </div>
</div>

<!-- Bulk Actions Bar -->
<div class="bulk-actions" [class.active]="selectedUsers.length > 0">
  <div>
    <span>{{ selectedUsers.length }}</span> users selected
  </div>
  <div class="bulk-buttons">
    <button class="btn btn-sm btn-secondary" (click)="bulkSuspend()">
      Suspend
    </button>
    <button class="btn btn-sm btn-secondary" (click)="bulkUpgrade()">
      Upgrade to PRO
    </button>
    <button class="btn btn-sm btn-danger" (click)="bulkDelete()">Delete</button>
  </div>
</div>

<!-- Users Table -->
<div class="data-table">
  <div class="table-header">
    <h3>All Users</h3>
    <div class="table-actions">
      <select
        [(ngModel)]="planFilter"
        (change)="filterUsers()"
        class="plan-filter"
      >
        <option value="all">All Plans</option>
        <option value="free">FREE Only</option>
        <option value="pro">PRO Only</option>
      </select>
      <button class="btn btn-secondary btn-sm" (click)="exportUsers()">
        Export CSV
      </button>
    </div>
  </div>
  <table>
    <thead>
      <tr>
        <th>
          <input
            type="checkbox"
            [checked]="selectedUsers.length === paginatedUsers.length"
            (change)="toggleSelectAll($event)"
          />
        </th>
        <th>Name</th>
        <th>Email</th>
        <th>Plan</th>
        <th>Status</th>
        <th>Joined</th>
        <th>Last Active</th>
        <th>Usage</th>
        <th>Features</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for (user of paginatedUsers; track $index) {
        <tr>
          <td>
            <input
              type="checkbox"
              [checked]="isSelected(user.id)"
              (change)="toggleUserSelection(user.id, $event)"
            />
          </td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>
            <span
              class="plan-badge"
              [class.free]="user.plan === 'free'"
              [class.pro]="user.plan === 'pro'"
              >{{ user.plan.toUpperCase() }}</span
            >
          </td>
          <td>
            <span
              class="status-badge"
              [class.active]="user.status === 'active'"
              [class.inactive]="user.status === 'inactive'"
              [class.suspended]="user.status === 'suspended'"
              >{{ user.status }}</span
            >
          </td>
          <td>{{ user.joined | date : "MMM d, y" }}</td>
          <td>{{ user.lastActive | date : "MMM d, y" }}</td>
          <td>
            <div class="token-meter">
              <div
                class="token-fill"
                [class.danger]="user.tokenUsage > 90"
                [class.warning]="user.tokenUsage > 70 && user.tokenUsage <= 90"
                [style.width]="user.tokenUsage + '%'"
              ></div>
            </div>
            {{ user.tokenUsage }}% ({{ getModelDisplay(user.preferredModel) }})
          </td>
          <td>{{ getFeatureUsage(user) }}</td>
          <td>
            <button class="btn btn-sm btn-secondary" (click)="open(userDetailModal, user)">View</button>
            <button class="btn btn-sm btn-secondary">Edit</button>
          </td>
        </tr>
      }
    </tbody>
  </table>
  <div class="pagination">
    <button
      (click)="changePage(currentPage - 1)"
      [disabled]="currentPage === 1"
    >
      Previous
    </button>
    @for (page of getPageNumbers(); track $index) {
      <button
              (click)="changePage(page)" 
              [class.active]="page === currentPage"
              [disabled]="page === -1">
        {{ page === -1 ? '...' : page }}
      </button>
    }
    <button
      (click)="changePage(currentPage + 1)"
      [disabled]="currentPage === totalPages"
    >
      Next
    </button>
  </div>
  <app-pagination></app-pagination>
</div>

<!-- Add User Modal -->
<ng-template #addUserModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add New User</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="userName" placeholder="Full name" class="form-control">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="userEmail" placeholder="Email address" class="form-control">
    </div>
    <div class="form-group">
      <label>Plan</label>
      <select id="userPlan" class="form-control">
        <option value="free">FREE</option>
        <option value="pro">PRO</option>
      </select>
    </div>
    <div class="form-group">
      <label>Initial Password</label>
      <input type="password" id="userPassword" placeholder="Temporary password" class="form-control">
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cancel click')">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="modal.close('Save click')">Add User</button>
  </div>
</ng-template>

<!-- User Detail Modal -->
<ng-template #userDetailModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">User Details</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem">
      <div>
        <h4>Account Information</h4>
        <table style="width: 100%; margin-top: 1rem">
          <tr>
            <td style="padding: 0.5rem 0; color: #64748b">Name:</td>
            <td style="padding: 0.5rem 0">{{ currentViewingUser.name }}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem 0; color: #64748b">Email:</td>
            <td style="padding: 0.5rem 0">{{ currentViewingUser.email }}</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem 0; color: #64748b">Plan:</td>
            <td style="padding: 0.5rem 0">
              <span class="plan-badge" [class.pro]="currentViewingUser.plan === 'pro'">
                {{ currentViewingUser.plan.toUpperCase() }}
              </span>
            </td>
          </tr>
          <tr>
            <td style="padding: 0.5rem 0; color: #64748b">Status:</td>
            <td style="padding: 0.5rem 0">
              <span class="status-badge" [class.active]="currentViewingUser.status === 'active'"
                                      [class.inactive]="currentViewingUser.status === 'inactive'"
                                      [class.suspended]="currentViewingUser.status === 'suspended'">
                {{ currentViewingUser.status }}
              </span>
            </td>
          </tr>
          <tr>
            <td style="padding: 0.5rem 0; color: #64748b">Joined:</td>
            <td style="padding: 0.5rem 0">{{ currentViewingUser.joined | date:'MMM d, y' }}</td>
          </tr>
        </table>
      </div>
      <div>
        <h4>Usage Statistics</h4>
        <div style="margin-top: 1rem">
          <div style="margin-bottom: 1rem">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem">
              <span>Token Usage</span>
              <span>{{ currentViewingUser.tokenUsage }}%</span>
            </div>
            <div class="token-meter">
              <div class="token-fill" 
                   [class.danger]="currentViewingUser.tokenUsage > 90"
                   [class.warning]="currentViewingUser.tokenUsage > 70 && currentViewingUser.tokenUsage <= 90"
                   [style.width]="currentViewingUser.tokenUsage + '%'"></div>
            </div>
          </div>
          <table style="width: 100%">
            <tr>
              <td style="padding: 0.5rem 0; color: #64748b">
                Model Preference:
              </td>
              <td style="padding: 0.5rem 0">{{ getModelDisplay(currentViewingUser.preferredModel) }}</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem 0; color: #64748b">
                Analyses Completed:
              </td>
              <td style="padding: 0.5rem 0">{{ currentViewingUser.analysesCompleted }}</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem 0; color: #64748b">
                Last Active:
              </td>
              <td style="padding: 0.5rem 0">{{ currentViewingUser.lastActive | date:'MMM d, y' }}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Plan-specific features -->
     @if (currentViewingUser) {
       <div style="margin-top: 2rem">
         <h4>Feature Usage</h4>
         @switch (currentViewingUser.plan) {
             @case('free'){
              <div class="feature-stats">
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem">
                <div class="feature-stat">
                  <div class="feature-stat-title">Values Created</div>
                  <div class="feature-stat-value">{{ currentViewingUser.valuesCreated }} / 10</div>
                </div>
                <div class="feature-stat">
                  <div class="feature-stat-title">Values Analyses</div>
                  <div class="feature-stat-value">{{ currentViewingUser.analysesCompleted }}</div>
                </div>
              </div>
              </div>
            }
            @case('pro'){
           <div class="feature-stats">

              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem">
                <div class="feature-stat">
                  <div class="feature-stat-title">Core Documents</div>
                  <div class="feature-stat-value">{{ currentViewingUser.coreDocsUploaded }} / 10</div>
                </div>
                <div class="feature-stat">
                  <div class="feature-stat-title">Reference URLs</div>
                  <div class="feature-stat-value">{{ currentViewingUser.refsAdded }} / 5</div>
                </div>
                <div class="feature-stat">
                  <div class="feature-stat-title">Document Analyses</div>
                  <div class="feature-stat-value">{{ currentViewingUser.analysesCompleted }}</div>
                </div>
                <div class="feature-stat">
                  <div class="feature-stat-title">Token Top-ups</div>
                  <div class="feature-stat-value">{{ currentViewingUser.tokenTopups }}</div>
                </div>
              </div>
            </div>
            }
         }
       </div>
     }

    <div style="margin-top: 2rem">
      <h4>Recent Activity</h4>
      <div class="activity-graph">
        @for (day of [0,1,2,3,4,5,6]; track $index; let i = $index) {
          <div 
               class="activity-bar" 
               [style.height]="(20 + Math.random() * 80) + '%'"
               [style.left]="(i * (100/7) + 2) + '%'"
               [title]="'Day ' + (i + 1) + ' activity'">
          </div>
        }
      </div>
    </div>

    <div style="margin-top: 2rem">
      <h4>Recent Analyses</h4>
      <table style="width: 100%; margin-top: 1rem">
        <thead>
          <tr>
            <th>Type</th>
            <th>Date</th>
            <th>Items Checked</th>
            <th>Alignment</th>
            <th>Tokens Used</th>
          </tr>
        </thead>
        <tbody>
          @for (analysis of getRecentAnalyses(currentViewingUser); track $index) {
            <tr>
              <td>{{ analysis.type }}</td>
              <td>{{ analysis.date | date:'MMM d, y' }}</td>
              <td>{{ analysis.items }}</td>
              <td>
                <span [style.color]="analysis.alignment >= 85 ? '#10b981' : 
                                     analysis.alignment >= 70 ? '#f59e0b' : '#ef4444'">
                  {{ analysis.alignment }}%
                </span>
              </td>
              <td>{{ analysis.tokens | number }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Close click')">Close</button>
    <button type="button" class="btn btn-primary">Edit User</button>
    <button type="button" class="btn btn-danger" (click)="suspendUserFromView()">Suspend User</button>
  </div>
</ng-template>